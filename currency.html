<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AZ Central Bank Currency Rates</title>
<meta name="color-scheme" content="light dark">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* ----- Design Tokens ----- */
:root {
  --bg-gradient: radial-gradient(circle at 20% 20%, #5e8cff 0%, #4361ee 25%, #3a0ca3 55%, #240046 100%);
  --glass-bg: rgba(255,255,255,0.18);
  --glass-bg-solid: rgba(255,255,255,0.65);
  --glass-border: rgba(255,255,255,0.35);
  --danger: #f94144;
  --warning: #f8961e;
  --ok: #2ea44f;
  --text: #1f2d3d;
  --text-soft: #5a6b7f;
  --accent: #ffbe0b;
  --accent-alt: #ff006e;
  --shadow: 0 8px 28px -6px rgba(0,0,0,0.35);
  --radius: 18px;
  --focus-ring: 0 0 0 3px rgba(255,190,11,.55), 0 0 0 6px rgba(255,0,110,.35);
  --header-gradient: linear-gradient(90deg,#ffbe0b,#ff006e 45%,#8338ec 80%);
}
[data-theme="dark"] {
  --glass-bg: rgba(22,25,37,0.35);
  --glass-bg-solid: rgba(22,25,37,0.8);
  --glass-border: rgba(255,255,255,0.15);
  --text: #f3f6f9;
  --text-soft: #a8b2c0;
  --shadow: 0 8px 32px -6px rgba(0,0,0,0.65);
  --header-gradient: linear-gradient(90deg,#ffbe0b,#ff006e 40%,#8338ec 75%);
}
[data-theme="light"] {
  --bg-gradient: radial-gradient(circle at 30% 30%, #ffe8a0 0%, #ffd36b 22%, #ff9fb2 52%, #b089f1 85%);
  --glass-bg: rgba(255,255,255,0.55);
  --glass-bg-solid: rgba(255,255,255,0.75);
  --glass-border: rgba(0,0,0,0.08);
  --text: #1c2030;
  --text-soft: #4d5667;
  --shadow: 0 6px 22px -4px rgba(0,0,0,0.25);
  --focus-ring: 0 0 0 3px rgba(255,0,110,.4),0 0 0 6px rgba(255,190,11,.35);
}
/* ----- Global Layout ----- */
html,body {
  height:100%;
  margin:0;
  font-family: "Poppins", system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  background: linear-gradient(115deg,#0f0c29,#302b63,#24243e);
  overflow-x: hidden;
}
body::before {
  content:"";
  position:fixed;
  inset:0;
  background: var(--bg-gradient);
  opacity:.68;
  filter: saturate(115%) brightness(1.05);
  animation: bgMove 35s linear infinite;
  z-index:-3;
}
@keyframes bgMove {
  0% { transform: scale(1) translate(0,0); }
  50% { transform: scale(1.15) translate(-3%,2%); }
  100% { transform: scale(1) translate(0,0); }
}
/* Floating particle dots */
.particles {
  position:fixed; inset:0; pointer-events:none;
  z-index:-2;
}
.particles span {
  position:absolute;
  width:10px; height:10px;
  background: radial-gradient(circle at 30% 30%, #fff 0%, rgba(255,255,255,0.05) 70%);
  border-radius:50%;
  animation: float 17s linear infinite;
  mix-blend-mode: screen;
  opacity:.4;
}
@keyframes float {
  0% { transform: translateY(0) scale(0.8); }
  50% { transform: translateY(-120vh) scale(1); }
  100% { transform: translateY(0) scale(0.8); }
}
/* ----- Containers ----- */
.wrapper {
  max-width: 1320px;
  margin: clamp(12px,4vw,48px) auto 120px;
  padding: 0 clamp(12px,3vw,36px);
}
.header {
  display:flex;
  flex-direction:column;
  gap:12px;
  align-items:flex-start;
  margin-bottom: 32px;
}
h1 {
  font-size: clamp(1.9rem,4.2vw,3.4rem);
  line-height:1.08;
  margin:0;
  background: var(--header-gradient);
  -webkit-background-clip:text;
  color: transparent;
  filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
  font-weight:700;
  letter-spacing:.5px;
}
.sub {
  font-size: clamp(.95rem,1.2vw,1.07rem);
  color: var(--text-soft);
  max-width:680px;
  backdrop-filter: blur(8px);
  background: var(--glass-bg);
  padding:10px 14px;
  border-radius: 12px;
  border: 1px solid var(--glass-border);
}
/* ----- Glass Panels ----- */
.panel {
  background: var(--glass-bg);
  backdrop-filter: blur(18px) saturate(160%);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius);
  padding: clamp(14px,2.2vw,28px);
  position: relative;
  overflow:hidden;
  box-shadow: var(--shadow);
  animation: rise .8s ease;
}
@keyframes rise {
  from { transform: translateY(18px) scale(.95); opacity:0; }
  to { transform: translateY(0) scale(1); opacity:1; }
}
.panel::before {
  content:"";
  position:absolute;
  top:-20%; left:-20%;
  width:60%; height:60%;
  background: conic-gradient(from 35deg,#ffbe0b 0%,#ff006e 55%,#8338ec 85%,#ffbe0b 100%);
  opacity:.15;
  filter: blur(55px);
  animation: swirl 22s linear infinite;
  pointer-events:none;
}
@keyframes swirl {
  to { transform: rotate(360deg); }
}
/* ----- Controls ----- */
.controls {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  align-items:center;
  margin-bottom: 20px;
}
.controls > * { flex: 0 0 auto; }
.input-group {
  display:flex;
  flex-direction:column;
  gap:6px;
}
label { font-weight:600; font-size:.72rem; letter-spacing:.5px; text-transform:uppercase; color: var(--text-soft); }
input[type="date"], select {
  padding: 8px 12px;
  font-size: .75rem;
  border-radius: 10px;
  border: 1px solid var(--glass-border);
  background: var(--glass-bg-solid);
  color: var(--text);
  outline:none;
  min-width:140px;
  max-width:160px;
  transition: box-shadow .25s, border-color .25s, background .25s;
  font-weight:500;
}
select {
  height:34px;
  cursor:pointer;
}
input[type="date"]:focus, select:focus {
  box-shadow: var(--focus-ring);
  border-color: var(--accent);
}
.buttons-bar {
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.btn {
  --btn-bg: linear-gradient(150deg,#ffbe0b,#ff006e 55%,#8338ec);
  position:relative;
  border:none;
  border-radius: 14px;
  padding: 12px 18px;
  font-weight:600;
  font-size:.85rem;
  letter-spacing:.5px;
  cursor:pointer;
  color:#fff;
  background: var(--btn-bg);
  box-shadow: 0 4px 18px -6px rgba(0,0,0,.5);
  transition: transform .35s, box-shadow .35s;
}
.btn:hover {
  transform: translateY(-4px);
  box-shadow: 0 10px 28px -6px rgba(0,0,0,.55);
}
.btn:active {
  transform: translateY(0);
  box-shadow: 0 4px 18px -6px rgba(0,0,0,.55);
}
.btn.secondary {
  background: linear-gradient(120deg,#4cc9f0,#4361ee 70%);
}
.btn.ghost {
  background: var(--glass-bg-solid);
  color: var(--text);
  box-shadow:none;
  border:1px solid var(--glass-border);
}
.btn.ghost:hover {
  background: var(--glass-bg);
  transform: translateY(-2px);
}
/* Theme toggle switch */
.theme-toggle {
  position:relative;
  display:inline-flex;
  align-items:center;
  gap:10px;
  cursor:pointer;
  user-select:none;
  font-size:.68rem;
  font-weight:600;
  letter-spacing:.5px;
  color: var(--text-soft);
}
.theme-toggle input { display:none; }
.toggle-pill {
  width:54px; height:26px;
  background: var(--glass-bg-solid);
  border-radius: 999px;
  position:relative;
  border:1px solid var(--glass-border);
  transition: background .4s;
}
.toggle-knob {
  position:absolute;
  top:50%; left:6px;
  width:18px; height:18px;
  background: linear-gradient(140deg,#fff,#e2e6ea);
  border-radius:50%;
  transform: translateY(-50%);
  box-shadow: 0 3px 10px -2px rgba(0,0,0,.45);
  transition: left .4s, background .4s;
}
.theme-toggle input:checked + .toggle-pill .toggle-knob {
  left: calc(100% - 24px);
  background: linear-gradient(140deg,#ffbe0b,#ff006e);
}
/* Latest file pills */
#latestList {
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  margin-top:12px;
}
.pill {
  position:relative;
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 18px;
  background: var(--glass-bg-solid);
  border:1px solid var(--glass-border);
  border-radius: 50px;
  backdrop-filter: blur(6px);
  font-size:.75rem;
  letter-spacing:.35px;
  color: var(--text);
  transition: background .4s, transform .4s;
  cursor:pointer;
  font-weight:600;
}
.pill:hover {
  background: var(--glass-bg);
  transform: translateY(-3px);
}
/* Status / Error */
.status-line {
  font-size:.65rem;
  letter-spacing:.6px;
  text-transform:uppercase;
  margin-top:10px;
  color: var(--text-soft);
  display:flex;
  align-items:center;
  gap:8px;
}
#errorBox {
  display:none;
  margin-top:16px;
  padding:14px 18px;
  border:1px solid rgba(255,0,110,.45);
  background: rgba(255,0,110,.06);
  color: var(--danger);
  border-radius: 14px;
  font-size:.78rem;
}
#fileMeta {
  display:none;
  margin-top:14px;
  font-size:.65rem;
  letter-spacing:.5px;
  color: var(--text-soft);
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
/* ----- Table ----- */
.table-wrap {
  margin-top: 22px;
  border-radius: var(--radius);
  overflow:hidden;
  box-shadow: var(--shadow);
  backdrop-filter: blur(16px);
  background: var(--glass-bg);
  border:1px solid var(--glass-border);
  transform: translateY(8px);
  opacity:0;
  transition: opacity .6s .1s, transform .6s .1s;
}
.table-wrap.visible {
  transform: translateY(0);
  opacity:1;
}
table {
  width:100%;
  border-collapse:collapse;
  font-size:.78rem;
  table-layout:fixed;
}
thead {
  background: linear-gradient(90deg,rgba(255,255,255,.18),rgba(255,255,255,.06));
  backdrop-filter: blur(6px);
}
th,td {
  padding: 6px 10px;
  text-align:center;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
th {
  position:relative;
  font-size:.9rem;
  text-transform:uppercase;
  letter-spacing:.9px;
  font-weight:700;
  color: #fff;
  background: linear-gradient(135deg,#ff006e,#8338ec 55%,#ffbe0b);
  -webkit-background-clip:text;
  color:transparent;
  cursor:pointer;
  user-select:none;
  font-family:"Poppins",sans-serif;
}
th span.sort-indicator {
  position:absolute;
  right:8px; top:50%; transform:translateY(-50%);
  font-size:.65rem;
  opacity:.75;
  color:#ff006e;
  background: none;
}
tbody tr {
  transition: background .25s;
}
tbody tr:nth-child(even){
  background: rgba(255,255,255,.05);
}
tbody tr:hover {
  background: rgba(255,255,255,.15);
}
tbody td {
  font-weight:500;
  color: var(--text);
  font-size:.72rem;
  letter-spacing:.3px;
}
/* Column widths */
th:nth-child(1), td:nth-child(1){ width:90px; }
th:nth-child(2), td:nth-child(2){ width:90px; }
th:nth-child(3), td:nth-child(3){ width:180px; }
th:nth-child(4), td:nth-child(4){ width:110px; }
/* Filter bar */
.filter-bar {
  display:flex;
  flex-wrap:wrap;
  gap:16px;
  margin-top:10px;
  align-items:center;
}
.badge {
  background: linear-gradient(120deg,#ff006e,#8338ec);
  padding:6px 12px;
  border-radius: 999px;
  font-size:.6rem;
  letter-spacing:.7px;
  color:#fff;
  font-weight:600;
  box-shadow: 0 6px 18px -8px rgba(0,0,0,.6);
}
/* Loading spinner */
.spinner {
  width:50px;height:50px;
  border: 5px solid rgba(255,255,255,.2);
  border-top:5px solid #ffbe0b;
  border-right:5px solid #ff006e;
  border-radius:50%;
  animation: spin 1s linear infinite, pulse 1.8s ease-in-out infinite;
  margin: 30px auto;
  filter: drop-shadow(0 4px 10px rgba(0,0,0,.35));
  display:none;
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(.88); } }
/* Responsive adjustments */
@media (max-width: 860px) {
  .controls { flex-direction:column; align-items:stretch; }
  .buttons-bar { width:100%; }
  .btn { flex:1 1 auto; }
  .panel { padding: 22px 20px; }
  .filter-bar { flex-direction:column; align-items:stretch; }
  #latestList { gap:10px; }
  .pill { width:100%; justify-content:space-between; }
  th,td { padding:8px 8px; }
}
/* Focus visible */
:focus-visible {
  outline:none;
  box-shadow: var(--focus-ring);
}
/* Scrollbar */
::-webkit-scrollbar { width:10px; }
::-webkit-scrollbar-track { background: rgba(255,255,255,.05); }
::-webkit-scrollbar-thumb {
  background: linear-gradient(160deg,#ffbe0b,#ff006e);
  border-radius:10px;
}
</style>
</head>
<body>

<div class="particles" aria-hidden="true">
  <!-- Decorative particles -->
  <span style="left:8%; animation-delay:0s;"></span>
  <span style="left:22%; animation-delay:4s;"></span>
  <span style="left:41%; animation-delay:2s;"></span>
  <span style="left:58%; animation-delay:6s;"></span>
  <span style="left:73%; animation-delay:1s;"></span>
  <span style="left:89%; animation-delay:5s;"></span>
</div>

<div class="wrapper">
  <header class="header">
    <h1>Currency Rates • Azerbaijan</h1>
    <div class="sub">
      Latest three currency XML datasets. Select date, refresh, sort, and theme toggle. Older files are automatically removed.
    </div>
  </header>

  <section class="panel" aria-labelledby="panelHeading">
    <div class="controls">
      <div class="input-group">
        <label for="dateInput">Select Date</label>
        <input id="dateInput" type="date" />
      </div>
      <div class="input-group">
        <label for="filterSelect">Filter (Code or Name)</label>
        <select id="filterSelect">
          <option value="__ALL__">All</option>
        </select>
      </div>
      <div class="buttons-bar">
        <button class="btn" id="loadSelectedBtn">Load Selected</button>
        <button class="btn secondary" id="refreshBtn" title="Rescan for latest 3 XML files">Refresh Latest</button>
        <button class="btn ghost" id="clearFilterBtn">Clear Filter</button>
      </div>
      <label class="theme-toggle" title="Toggle light / dark mode">
        <input type="checkbox" id="themeToggle" />
        <div class="toggle-pill"><div class="toggle-knob"></div></div>
        <span>Dark Mode</span>
      </label>
    </div>

    <div id="latestList" aria-live="polite"></div>
    <div class="status-line"><span id="status"></span></div>
    <div id="errorBox" role="alert"></div>

    <div id="fileMeta" class="status-line">
      <span class="badge">Loaded</span>
      <span id="fileName"></span>
    </div>

    <h2 id="dateHeader" style="margin:24px 4px 6px; font-size:1.2rem; letter-spacing:.5px;"></h2>

    <div class="filter-bar">
      <span class="badge" id="rowCount" style="display:none;"></span>
    </div>

    <div class="spinner" id="spinner" aria-hidden="true"></div>

    <div class="table-wrap" id="tableWrap">
      <table id="currencyTable" role="table" aria-describedby="dateHeader">
        <thead>
          <tr>
            <th data-key="Code">Code <span class="sort-indicator"></span></th>
            <th data-key="Nominal">Nominal <span class="sort-indicator"></span></th>
            <th data-key="Name">Name <span class="sort-indicator"></span></th>
            <th data-key="Value">Value <span class="sort-indicator"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </section>
</div>

<script>
/* =========================
   Currency Dashboard Logic (Modified)
========================= */
(function() {
  const dateInput = document.getElementById('dateInput');
  const filterSelect = document.getElementById('filterSelect');
  const loadSelectedBtn = document.getElementById('loadSelectedBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const clearFilterBtn = document.getElementById('clearFilterBtn');
  const latestList = document.getElementById('latestList');
  const statusEl = document.getElementById('status');
  const errorBox = document.getElementById('errorBox');
  const dateHeader = document.getElementById('dateHeader');
  const fileMeta = document.getElementById('fileMeta');
  const fileNameEl = document.getElementById('fileName');
  const spinner = document.getElementById('spinner');
  const tableWrap = document.getElementById('tableWrap');
  const table = document.getElementById('currencyTable');
  const tbody = table.querySelector('tbody');
  const rowCount = document.getElementById('rowCount');
  const themeToggle = document.getElementById('themeToggle');

  let currentData = [];
  let sortState = { key: null, dir: 1 };
  let latestFilesCache = [];

  document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    dateInput.value = toYMD(today);
    applySavedTheme();
    refreshLatest();
  });

  /* -------- Event Handlers -------- */
  filterSelect.addEventListener('change', () => applyFilter());
  clearFilterBtn.addEventListener('click', () => {
    filterSelect.value = '__ALL__';
    applyFilter();
  });
  loadSelectedBtn.addEventListener('click', () => {
    if (!dateInput.value) return showError('Please select a date.');
    loadFile(dateInput.value + '.xml', true);
  });
  refreshBtn.addEventListener('click', refreshLatest);
  themeToggle.addEventListener('change', toggleTheme);
  table.querySelectorAll('th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      handleSort(key, th);
    });
    th.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        const key = th.getAttribute('data-key');
        handleSort(key, th);
      }
    });
    th.setAttribute('tabindex','0');
  });

  /* -------- Utility Functions -------- */
  function toYMD(d) { return d.toISOString().slice(0, 10); }
  function setStatus(msg) { statusEl.textContent = msg || ''; }
  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.style.display = 'block';
  }
  function clearError() {
    errorBox.textContent = '';
    errorBox.style.display = 'none';
  }
  function startLoading() {
    spinner.style.display='block';
    tableWrap.classList.remove('visible');
  }
  function endLoading() {
    spinner.style.display='none';
  }
  async function headOrGetExists(url) {
    try {
      let res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
      if (res.ok) return true;
      if ([403,405].includes(res.status)) {
        res = await fetch(url, { method: 'GET', cache: 'no-store' });
        return res.ok;
      }
      return false;
    } catch {
      try {
        const res = await fetch(url, { method: 'GET', cache: 'no-store' });
        return res.ok;
      } catch { return false; }
    }
  }

  /* -------- Latest Files Scan -------- */
  async function refreshLatest() {
    clearError();
    setStatus('Scanning latest files...');
    latestList.innerHTML = '';
    startLoading();
    latestFilesCache = [];
    const maxSearchDays = 30;
    const today = new Date();
    for (let i = 0; i < maxSearchDays && latestFilesCache.length < 3; i++) {
      const d = new Date(today); d.setDate(today.getDate() - i);
      const filename = toYMD(d) + '.xml';
      const exists = await headOrGetExists('./' + filename);
      if (exists) latestFilesCache.push(filename);
    }
    endLoading();
    if (!latestFilesCache.length) {
      showError('No XML files found. Run the GitHub Action workflow.');
      setStatus('');
      return;
    }
    renderLatestPills(latestFilesCache);
    setStatus(`Found ${latestFilesCache.length} file(s).`);
    loadFile(latestFilesCache[0], false);
  }

  function renderLatestPills(files) {
    latestList.innerHTML = '';
    files.forEach(fn => {
      const pill = document.createElement('div');
      pill.className='pill'; pill.role='button'; pill.tabIndex=0;
      pill.innerHTML = `<strong>${fn.replace('.xml','')}</strong>`;
      pill.addEventListener('click', () => loadFile(fn,false));
      pill.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault(); loadFile(fn,false);
        }
      });
      latestList.appendChild(pill);
    });
  }

  /* -------- Load & Parse XML File -------- */
  async function loadFile(filename, warnIfMissing) {
    clearError();
    setStatus('Loading ' + filename + ' ...');
    startLoading();
    try {
      const res = await fetch('./' + filename, { cache: 'no-store' });
      if (!res.ok) {
        endLoading();
        if (warnIfMissing) showError(`File ${filename} not found.`);
        setStatus('');
        return;
      }
      const xmlText = await res.text();
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText,'application/xml');
      const parseErr = xmlDoc.querySelector('parsererror');
      if (parseErr) {
        endLoading();
        console.error(parseErr.textContent);
        showError('Failed to parse XML.');
        setStatus('');
        return;
      }
      renderRates(xmlDoc, filename);
      endLoading();
      setStatus('Loaded ' + filename);
    } catch (err) {
      endLoading();
      console.error(err);
      showError('Unexpected network or parsing error.');
      setStatus('');
    }
  }

  function renderRates(xmlDoc, filename) {
    const valCurs = xmlDoc.getElementsByTagName('ValCurs')[0];
    if (!valCurs) {
      showError('XML root <ValCurs> not found.');
      return;
    }
    const xmlDate = valCurs.getAttribute('Date') || '(Unknown Date)';
    dateHeader.textContent = 'Rates for ' + xmlDate;
    currentData = [];
    const valutes = xmlDoc.getElementsByTagName('Valute');
    for (const v of valutes) {
      currentData.push({
        Code: v.getAttribute('Code') || '',
        Nominal: getText(v,'Nominal'),
        Name: getText(v,'Name'),
        Value: getText(v,'Value')
      });
    }
    fileMeta.style.display='flex';
    fileNameEl.textContent = filename;
    sortState = { key:null, dir:1 };
    renderTableRows(currentData);
    populateFilterOptions();
    tableWrap.classList.add('visible');
    applyFilter();
  }

  function populateFilterOptions() {
    const prevValue = filterSelect.value;
    filterSelect.innerHTML = '<option value="__ALL__">All</option>';
    const optionsSet = new Set();
    currentData.forEach(d => {
      if (d.Code) optionsSet.add(d.Code);
      if (d.Name) optionsSet.add(d.Name);
    });
    [...optionsSet].sort().forEach(opt => {
      const o = document.createElement('option');
      o.value = opt;
      o.textContent = opt;
      filterSelect.appendChild(o);
    });
    if (optionsSet.has(prevValue)) {
      filterSelect.value = prevValue;
    } else {
      filterSelect.value = '__ALL__';
    }
  }

  function getText(node, tag) {
    const el = node.getElementsByTagName(tag)[0];
    return el ? el.textContent.trim() : '';
  }

  /* -------- Filtering -------- */
  function applyFilter() {
    const selected = filterSelect.value;
    let rows = Array.from(tbody.querySelectorAll('tr'));
    let visibleCount = 0;
    rows.forEach(r => {
      const cells = Array.from(r.children).map(c => c.textContent);
      const match = selected === '__ALL__' || cells.some(txt => txt === selected);
      r.style.display = match ? '' : 'none';
      if (match) visibleCount++;
    });
    rowCount.style.display='inline-block';
    rowCount.textContent = visibleCount + ' row(s)';
  }

  /* -------- Sorting -------- */
  function handleSort(key, th) {
    if (sortState.key === key) {
      sortState.dir = -sortState.dir;
    } else {
      sortState.key = key;
      sortState.dir = 1;
    }
    table.querySelectorAll('th .sort-indicator').forEach(si => si.textContent='');
    const indicator = th.querySelector('.sort-indicator');
    indicator.textContent = sortState.dir === 1 ? '▲' : '▼';
    const sorted = currentData.slice().sort((a,b) => compareValues(a[key], b[key]) * sortState.dir);
    renderTableRows(sorted);
    populateFilterOptions();
    applyFilter();
  }
  function compareValues(a,b) {
    const numA = parseFloat(a.replace(',','.'));
    const numB = parseFloat(b.replace(',','.'));
    if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
    return a.localeCompare(b, undefined, { sensitivity:'base' });
  }

  function renderTableRows(data) {
    tbody.innerHTML = '';
    for (const row of data) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(row.Code)}</td>
        <td>${escapeHtml(row.Nominal)}</td>
        <td>${escapeHtml(row.Name)}</td>
        <td>${escapeHtml(row.Value)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, c => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    })[c]);
  }

  /* -------- Theme Handling -------- */
  function toggleTheme() {
    const isDark = themeToggle.checked;
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    localStorage.setItem('dashboard-theme', isDark ? 'dark' : 'light');
  }
  function applySavedTheme() {
    const saved = localStorage.getItem('dashboard-theme');
    if (saved === 'dark') {
      themeToggle.checked = true;
      document.documentElement.setAttribute('data-theme','dark');
    }
  }

})();
</script>
</body>
</html>
